<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Turnos</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- SweetAlert para notificaciones -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Manifest para PWA -->
    <link rel="manifest" href="/manifest.json">
    <!-- Iconos para PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
    <!-- Estilos personalizados -->
    <style>
        body { background-color: #f8f9fa; }
        .table thead { background-color: #ff9800; color: white; }
        .table tbody tr:hover { background-color: #ffe0b2; transition: background-color 0.3s; }
        .extra { background-color: yellow; }
        .domingo { background-color: lightcoral; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center text-primary">Registro de turno</h2>
        <input type="text" id="searchInput" class="form-control mb-3" placeholder="Buscar registros" onkeyup="filtrarRegistros()">
        <form id="turnoForm" class="p-4 shadow rounded bg-white fade-in">
            <div class="mb-3">
                <label class="form-label">Nombre:</label>
                <input type="text" id="nombre" class="form-control" required aria-label="Nombre">
            </div>
            <div class="mb-3">
                <label class="form-label">Apellido:</label>
                <input type="text" id="apellido" class="form-control" required aria-label="Apellido">
            </div>
            <div class="mb-3">
                <label class="form-label">Fecha Entrada:</label>
                <input type="date" id="fechaEntrada" class="form-control" required aria-label="Fecha de entrada">
                <input type="time" id="horaEntrada" class="form-control mt-2" required aria-label="Hora de entrada">
            </div>
            <div class="mb-3">
                <label class="form-label">Fecha Salida:</label>
                <input type="date" id="fechaSalida" class="form-control" required aria-label="Fecha de salida">
                <input type="time" id="horaSalida" class="form-control mt-2" required aria-label="Hora de salida">
            </div>
            <button type="button" class="btn btn-success w-100" onclick="guardarRegistro()">Registrar</button>
        </form>

        <button class="btn btn-primary mt-3 w-100" onclick="descargarExcel()">Descargar Registros (Excel)</button>
        <button class="btn btn-danger mt-3 w-100" onclick="borrarHistorial()">Borrar Historial</button>

        <h3 class="mt-5">Registros:</h3>
        <table class="table table-bordered text-center mt-3">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Fecha Entrada</th>
                    <th>Hora Entrada</th>
                    <th>Fecha Salida</th>
                    <th>Hora Salida</th>
                    <th>Horas Trabajadas</th>
                    <th>Horas Extras</th>
                    <th>Recargos Nocturnos</th>
                    <th>Domingo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaRegistros"></tbody>
        </table>
    </div>

    <!-- Script para registrar el Service Worker -->
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("/sw.js")
                    .then((registration) => {
                        console.log("Service Worker registrado con éxito:", registration.scope);
                    })
                    .catch((error) => {
                        console.log("Error al registrar el Service Worker:", error);
                    });
            });
        }
    </script>

    <!-- Script principal de la aplicación -->
    <script>
        let registros = JSON.parse(localStorage.getItem("registros")) || [];

        function mostrarNotificacion(titulo, mensaje, tipo) {
            Swal.fire({
                title: titulo,
                text: mensaje,
                icon: tipo,
                confirmButtonText: "Aceptar"
            });
        }

        function validarFormatoHora(hora) {
            const regex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            return regex.test(hora);
        }

        function guardarRegistro() {
            const nombre = document.getElementById("nombre").value.trim();
            const apellido = document.getElementById("apellido").value.trim();
            const fechaEntrada = document.getElementById("fechaEntrada").value;
            const horaEntrada = document.getElementById("horaEntrada").value;
            const fechaSalida = document.getElementById("fechaSalida").value;
            const horaSalida = document.getElementById("horaSalida").value;

            if (!nombre || !apellido || !fechaEntrada || !horaEntrada || !fechaSalida || !horaSalida) {
                mostrarNotificacion("Error", "Por favor, completa todos los campos.", "error");
                return;
            }

            if (!validarFormatoHora(horaEntrada) || !validarFormatoHora(horaSalida)) {
                mostrarNotificacion("Error", "Formato de hora inválido. Usa HH:MM.", "error");
                return;
            }

            let inicio = new Date(`${fechaEntrada}T${horaEntrada}`);
            let fin = new Date(`${fechaSalida}T${horaSalida}`);

            if (fin <= inicio) {
                mostrarNotificacion("Error", "La fecha y hora de salida no pueden ser anteriores o iguales a la de entrada.", "error");
                return;
            }

            let horasTrabajadas = (fin - inicio) / (1000 * 60 * 60);
            let extras = horasTrabajadas > 8 ? horasTrabajadas - 8 : 0;
            let recargosNocturnos = calcularRecargosNocturnos(inicio, fin);
            let esDomingo = inicio.getDay() === 0 ? "Sí" : "No";

            let nuevoRegistro = [nombre, apellido, fechaEntrada, horaEntrada, fechaSalida, horaSalida, horasTrabajadas.toFixed(2), extras.toFixed(2), recargosNocturnos, esDomingo];

            registros.push(nuevoRegistro);
            localStorage.setItem("registros", JSON.stringify(registros));

            actualizarTabla();
            mostrarNotificacion("Éxito", "Registro guardado con éxito!", "success");
            document.getElementById("turnoForm").reset();
        }

        function calcularRecargosNocturnos(inicio, fin) {
            const HORA_NOCTURNA_INICIO = 21;
            const HORA_NOCTURNA_FIN = 6;
            let totalRecargos = 0;

            if (fin < inicio) {
                fin.setDate(fin.getDate() + 1);
            }

            let inicioMinutos = inicio.getHours() * 60 + inicio.getMinutes();
            let finMinutos = fin.getHours() * 60 + fin.getMinutes();

            if (finMinutos < inicioMinutos) {
                finMinutos += 24 * 60;
            }

            for (let minuto = inicioMinutos; minuto < finMinutos; minuto++) {
                let horaActual = (minuto % (24 * 60)) / 60;

                if (horaActual >= HORA_NOCTURNA_INICIO || horaActual < HORA_NOCTURNA_FIN) {
                    totalRecargos += 1 / 60;
                }
            }

            return totalRecargos.toFixed(2);
        }

        function actualizarTabla() {
            let tabla = document.getElementById("tablaRegistros");
            tabla.innerHTML = "";

            registros.forEach((row, index) => {
                let tr = document.createElement("tr");
                row.forEach((cell, cellIndex) => {
                    let td = document.createElement("td");
                    td.textContent = cell;

                    if (cellIndex === 7 && parseFloat(cell) > 0) { td.classList.add("extra"); }
                    if (cellIndex === 9 && cell === "Sí") { td.classList.add("domingo"); }

                    tr.appendChild(td);
                });

                let tdAcciones = document.createElement("td");
                let btnEditar = document.createElement("button");
                btnEditar.textContent = "Editar";
                btnEditar.classList.add("btn", "btn-warning", "btn-sm", "me-2");
                btnEditar.onclick = () => editarRegistro(index);
                tdAcciones.appendChild(btnEditar);

                let btnEliminar = document.createElement("button");
                btnEliminar.textContent = "Eliminar";
                btnEliminar.classList.add("btn", "btn-danger", "btn-sm");
                btnEliminar.onclick = () => eliminarRegistro(index);
                tdAcciones.appendChild(btnEliminar);

                tr.appendChild(tdAcciones);
                tabla.appendChild(tr);
            });
        }

        function editarRegistro(index) {
            let registro = registros[index];
            document.getElementById("nombre").value = registro[0];
            document.getElementById("apellido").value = registro[1];
            document.getElementById("fechaEntrada").value = registro[2];
            document.getElementById("horaEntrada").value = registro[3];
            document.getElementById("fechaSalida").value = registro[4];
            document.getElementById("horaSalida").value = registro[5];

            registros.splice(index, 1);
            localStorage.setItem("registros", JSON.stringify(registros));
            actualizarTabla();
        }

        function eliminarRegistro(index) {
            Swal.fire({
                title: "¿Eliminar registro?",
                text: "Esta acción no se puede deshacer.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    registros.splice(index, 1);
                    localStorage.setItem("registros", JSON.stringify(registros));
                    actualizarTabla();
                    mostrarNotificacion("Éxito", "Registro eliminado.", "success");
                }
            });
        }

        function borrarHistorial() {
            Swal.fire({
                title: "¿Borrar historial?",
                text: "Todos los registros serán eliminados.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, borrar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    registros = [];
                    localStorage.removeItem("registros");
                    actualizarTabla();
                    mostrarNotificacion("Éxito", "Historial borrado.", "success");
                }
            });
        }

        function descargarExcel() {
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet([
                ["Nombre", "Apellido", "Fecha Entrada", "Hora Entrada", "Fecha Salida", "Hora Salida", "Horas Trabajadas", "Horas Extras", "Recargos Nocturnos", "Domingo"]
            ]);

            registros.forEach(registro => {
                XLSX.utils.sheet_add_aoa(ws, [registro], {origin: -1});
            });

            const fechaActual = new Date().toISOString().split('T')[0];
            XLSX.utils.book_append_sheet(wb, ws, "Registros");
            XLSX.writeFile(wb, `registros_turnos_${fechaActual}.xlsx`);
        }

        function filtrarRegistros() {
            const busca = document.getElementById("searchInput").value.toLowerCase();
            const tabla = document.getElementById("tablaRegistros");
            const filas = tabla.getElementsByTagName("tr");

            for (let i = 0; i < filas.length; i++) {
                const celdas = filas[i].getElementsByTagName("td");
                let mostrarFila = false;

                for (let j = 0; j < celdas.length - 1; j++) { // Excluir la columna de acciones
                    if (celdas[j].textContent.toLowerCase().includes(busca)) {
                        mostrarFila = true;
                        break;
                    }
                }

                filas[i].style.display = mostrarFila ? "" : "none";
            }
        }

        window.onload = actualizarTabla;
    </script>
</body>
</html>
